# the list of built-in mechanisms to be provided by default
set(mechanisms pas hh expsyn exp2syn)

# set the flags for the modcc compiler that converts NMODL
# files to C++/CUDA source.
set(modcc_flags "-t cpu")

# make path for the kernels that will be generated by modcc
file(MAKE_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR}/multicore)
if(WITH_CUDA)
    file(MAKE_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR}/gpu)
endif()

# generate source for each mechanism
foreach(mech ${mechanisms})
    set(mod "${CMAKE_CURRENT_SOURCE_DIR}/../../mechanisms/mod/${mech}.mod")
    set(hpp "${CMAKE_CURRENT_SOURCE_DIR}/multicore/${mech}.hpp")
    if(use_external_modcc)
        add_custom_command(
           OUTPUT "${hpp}"
           WORKING_DIRECTORY "${CMAKE_CURRENT_SOURCE_DIR}"
           COMMAND ${modcc} ${modcc_flags} ${mod} -o ${hpp} -m ${mech}_proto
       )
    else()
        add_custom_command(
            OUTPUT "${hpp}"
            DEPENDS modcc "${mod}"
            WORKING_DIRECTORY "${CMAKE_CURRENT_SOURCE_DIR}"
            COMMAND ${modcc} ${modcc_flags} ${mod} -o ${hpp} -m ${mech}_proto
        )
    endif()
    set_source_files_properties("${hpp}" PROPERTIES GENERATED TRUE)
    list(APPEND test_mod_hpps "${hpp}")
endforeach()

# Fake target to always trigger .mod -> .hpp dependencies because wtf CMake
add_custom_target(build_test_mods DEPENDS ${test_mod_hpps} modcc)

# oh sweet jesus, CMake is a dog's breakfast.
# that said, let'g go through the same dance to generate CUDA kernels if
# we are targetting the GPU.
if(WITH_CUDA)
    set(modcc_flags "-t gpu")

    if(USE_OPTIMIZED_KERNELS)
        set(modcc_flags ${modcc_flags} -O)
    endif()

    # generate source for each mechanism
    foreach(mech ${mechanisms})
        set(mod "${CMAKE_CURRENT_SOURCE_DIR}/mod/${mech}.mod")
        set(hpp "${CMAKE_CURRENT_SOURCE_DIR}/gpu/${mech}.hpp")
        if(use_external_modcc)
            add_custom_command(
               OUTPUT "${hpp}"
               WORKING_DIRECTORY "${CMAKE_CURRENT_SOURCE_DIR}"
               COMMAND ${modcc} ${modcc_flags} ${mod} -o ${hpp} -m ${mech}_proto
           )
        else()
            add_custom_command(
                OUTPUT "${hpp}"
                DEPENDS modparser "${mod}"
                WORKING_DIRECTORY "${CMAKE_CURRENT_SOURCE_DIR}"
                COMMAND ${modcc} ${modcc_flags} ${mod} -o ${hpp} -m ${mech}_proto
            )
        endif()
        set_source_files_properties("${hpp}" PROPERTIES GENERATED TRUE)
        list(APPEND test_gpu_mod_hpps "${hpp}")
    endforeach()

    # Fake target to always trigger .mod -> .hpp dependencies because wtf CMake
    add_custom_target(build_test_gpu_mods DEPENDS ${test_gpu_mod_hpps} modcc)
endif()
